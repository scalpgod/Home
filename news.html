<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>News</title>
<link rel="stylesheet" href="news/jquery-mobile/jquery.mobile-1.4.2.css"/>
<link href="news/css/news.css" rel="stylesheet" type="text/css">
<script src="news/jquery-mobile/jquery-1.11.0.js" type="text/javascript"></script>
<script src="news/jquery-mobile/jquery.mobile-1.4.2.min.js" type="text/javascript"></script>
<script src ="news/js/moment.min.js"></script>
<script src="https://ws.livesquawk.com/ws3011/socket.io/socket.io.js"></script>
<meta name="viewport" content="width=device-width"/>

<script>var __adobewebfontsappname__="dreamweaver"</script>
<script src="https://use.edgefonts.net/open-sans:n3:default.js" type="text/javascript"></script>
</head>
<script type="text/javascript">

	var newsarray = [],
		wirMacro = [],
		wirPolicy = [],
		wirFlows = [],
		wirSupply = [],
		wirCommo = [],
		wirGeneral = [],
		wirTech = [],
		wirResearch = [],
		wirOutput = [],
		wirEmployment = [],
		wirProduction = [],
		wirHousing = [],
		wirPrices = [],
		wirMoney = [],
		wirGovFinance = [],
		wirTrade = [],
		wirSpeeches = [],
		wirAuction = [],
		wirWorld= [],
		wirResearch = [],
		wirOption = [];
	var calMacro = [];
    var calSupply = [];
    var calCommo = [];
    var calPolicy = [];
	var calTech=[];
	var calWorld = [];
	var calResearch = [];
	var calOutput = [];
    var calEmployment = [];
    var calProduction = [];
    var calHousing = [],calHousings = [];
	var calPrices=[];
	var calMoney = [];
    var calGovFinance = [];
    var calTrade = [];
    var calSpeeches = [];
	var calAuction=[];
	var calOption = [];
	var scrollID, scrollClass;
	var start, end, color, origin,idorg;
	var hasPlotBand = false;
	var myOffset = 3600000;
	var	myreset = true;
	var DSToffset = DST();


	function Reset() {
		//console.log("myreset", myreset,"origin", origin)
		if (myreset == true) {

			$("html, body").stop().animate({
				scrollTop: $("#origin").offset().top - 550
			}, 500);

		} else {
			myreset = true;
		}
	}



	function IndexTopic(topic) { //find wire series index for given topic
	wireArray = [];
	switch (topic) {
		case "Macro":
			return 2;
			break;
		case "Equity/Debt":
			return 6;
			break;
		case "Policymaker":
		case "Policy":
			return 4;
			break;
		case "Commodity":
			return 8;
			break;
		case "Technical":
			return 10;
			break;
		case "World Events":
			return 11;
			break;
		case "Research":
			return 12;
			break;
		case "Trade Recs":
			return 13;
			break;
	}
}

	function DST() { // check if daylight savings time

		Date.prototype.stdTimezoneOffset = function () {
			var jan = new Date(this.getFullYear(), 0, 1);
			var jul = new Date(this.getFullYear(), 6, 1);
			return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
		}
		Date.prototype.dst = function () {
			return this.getTimezoneOffset() < this.stdTimezoneOffset();
		}
		var today = new Date();
		//console.log("Daylight savings time!", today.dst(),moment().isDST());

		if (today.dst()) {
			//console.log("Daylight savings time!");
			return ;
		} else {
			return 3600000;
		}
	}

	function isinRange(newstime) {
		//console.log(start, newstime, end);
		if (newstime >= start && newstime <= end) {
			return true;
		} else {
			return false;
		}
	}

	function addWeekdays(date, days) {
	  date = moment(date); // use a clone
	  while (days > 0) {
		date = date.add(1, 'days');
		// decrease "days" only if it's a weekday.
		if (date.isoWeekday() !== 6 && date.isoWeekday() !== 7) {
		  days -= 1;
		}
	  }
	  return date;
	}

	function subtractWeekdays(date, days) {
	  date = moment(date); // use a clone
	  while (days > 0) {
		date = date.subtract(1, 'days');
		// decrease "days" only if it's a weekday.
		if (date.isoWeekday() !== 6 && date.isoWeekday() !== 7) {
		  days -= 1;
		}
	  }
	  return date;
	}

	// Connect to LS socket
	var sockets_on_page = true;
	var distributor_server = 3010;
	var assigned_server = 0;
	var socket;
	var current_port = 0;	
	

var publisher_channel = 'Mangocharts';

socket_connection_start(distributor_server);


function socket_connection_start(server) { 
	socket = io.connect('https://ws.livesquawk.com', { path: '/ws'+server+'/socket.io', transports: ['websocket'], upgrade: false, timeout: 10000, reconnectionAttempts: '3'} );
				var current_server = server;  
				socket.on('connect', function () { 
					//	$('.output').append('Connected to server '+current_server+'<br>');
						if (current_server == distributor_server) { socket.emit('request_server_assignment'); }
						else {
						socket.emit('join_channel', { publisher_channel: publisher_channel, username: 'Mangocharts', subscriber_group: '', display_name: 'Mangocharts', single_sign_on: '' });  
						}
				 });
	
				 socket.on('server_assignment_response',function(data) {
             assigned_server = data;
             socket.disconnect();
            //  $('.output').append('Disconnected from distributor<br>');
            //  $('.output').append('Client sent to server '+data+'<br>'); 
              socket_connection_start(assigned_server);
              console.log('assigned'+assigned_server); 
           });
	
					 socket.on('new note',function(data) {
						 
							var timestamp = data.date;
							var summertimestamp = timestamp + DSToffset;
							var message_date = new Date(timestamp);
							var mytime = message_date.toLocaleTimeString([], {
								hour: '2-digit',
								minute: '2-digit'
							});
							var mycategory = data.category;
							var mytitle = data.title;
							var mybody = data.body;
							var socketstring;
							

							if (mycategory == "Equity/Debt") {
								mycategory = "E";
							}

							if (mycategory == "World Events") {
								mycategory = "W";
							}
							if (mycategory == "Policymaker") {
								mycategory = "P";
							}
							if (mycategory == "Macro") {
								mycategory = "M";
							}

							if (mybody == "") {
								socketstring = "<div data-role='collapsible' data-collapsed-icon='false' data-disabled='true' class=" + mycategory + "><h1 id=" + timestamp + ">" + mytime + "&nbsp" + "&nbsp" + mycategory + " - " + mytitle + "</h1></div>"
									//console.log("empty");
							} else {
								socketstring = "<div data-role='collapsible' data-disabled='false' class=" + mycategory + "><h1 id=" + timestamp + ">" + mytime  + "&nbsp" + "&nbsp" + mycategory + " - " + mytitle + "</h1>" + mybody + "</div>"
							}

							$("#coll").prepend(socketstring).collapsibleset("refresh");


							newsarray.unshift({
								category: mycategory,
								date: timestamp,
								title: mytitle,
								body: mybody,
								id: data.id,
								channel: data.channel,
								importance: data.importance
							});
							//console.log("news");
							newsAdd(data);

				              
				            });
	
	
	
}



function newsAdd(jsonObj) { //add new wire news pushed by Main widget window
	//console.log("newsadd", jsonObj);
	var chart = $('#chart').highcharts(),
		data, seriesindex;
	var newstime = jsonObj.date;
	var topic = jsonObj.category;
	if (topic == "Policymaker") {
		topic = "Policy";
	}

	
}

</script>
<!---->
<body ontouchstart="">
<section id="page" data-role="page" data-theme="b"  >
  
   <div class="ui-content mynews">
      <div id="coll" data-role="collapsible-set" data-mini="true" data-theme="b" data-collapsed-icon="carat-d" data-expanded-icon="carat-u" data-iconpos="right"> </div>
    </div>
</section>
</body>
</html>
